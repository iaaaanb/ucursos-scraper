#!/bin/bash
set -e

# Post-installation script for ucursito

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Installing Ucursito - U-Cursos Scraper"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Install Python dependencies
echo "ğŸ“¦ Installing Python dependencies..."
if [ -f /opt/ucursito/requirements.txt ]; then
    # Try to install dependencies (--break-system-packages for Ubuntu 23.04+)
    if pip3 install -r /opt/ucursito/requirements.txt --break-system-packages --quiet --disable-pip-version-check 2>/dev/null; then
        echo "âœ“ Dependencies installed successfully"
    elif pip3 install -r /opt/ucursito/requirements.txt --quiet --disable-pip-version-check 2>/dev/null; then
        echo "âœ“ Dependencies installed successfully"
    else
        echo "âš ï¸  Warning: Could not install dependencies automatically"
        echo "   Please run manually:"
        echo "   sudo pip3 install -r /opt/ucursito/requirements.txt --break-system-packages"
    fi
else
    echo "âš ï¸  Warning: requirements.txt not found"
fi

# Create symlink to make ucursito available system-wide
echo "ğŸ”— Creating symlink /usr/local/bin/ucursito..."
ln -sf /opt/ucursito/ucursito /usr/local/bin/ucursito

# Make sure the wrapper script is executable
chmod +x /opt/ucursito/ucursito

# Make sure main.py is executable
chmod +x /opt/ucursito/src/main.py

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Ucursito installed successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ Installation location: /opt/ucursito"
echo "ğŸ”— Command: ucursito (available from anywhere)"
echo ""
echo "ğŸš€ Quick start:"
echo "   1. Run: ucursito"
echo "   2. Enter your U-Cursos credentials (first time only)"
echo "   3. Your files will be downloaded to ./downloads/"
echo ""
echo "ğŸ“– Usage examples:"
echo "   ucursito              # Sync all sections"
echo "   ucursito -c           # Export calendar only"
echo "   ucursito -m           # Download material docente only"
echo "   ucursito -mt          # Download material + tareas"
echo "   ucursito --serve-calendar  # Start calendar server"
echo ""
echo "ğŸ“š Documentation: /opt/ucursito/README.md"
echo "ğŸ”‘ Credentials: Stored in ~/.config/ucursito/credentials"
echo ""
echo "Need help? Run: ucursito --help"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

exit 0
